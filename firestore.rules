rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {

    match /tips/{id} {
          allow read: if true;
          allow create: if canCreate()
          allow update, delete: if isLoggedIn() && belongsTo();
        }

    function isLoggedIn() { 
      return request.auth.uid != null;
    }

    function belongsTo(userId) {
      return request.auth.uid == userId || request.auth.uid == resource.data.uid;
    }

    function canCreate() {
      let uid = request.auth.uid; 
      let hasValidTimestamp = request.time == request.resource.data.createdAt;
      return belongsTo(uid) && hasValidTimestamp;
    }
  }
}


